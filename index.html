<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILOCOSTUDIO | Administraci√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #c2a45d; --bg: #1a1a1a; --card: #262626; --red: #ff4d4d; --blue: #3498db; }
        body { margin: 0; background: var(--bg); color: #f5f5f5; font-family: 'Montserrat', sans-serif; }
        
        header { 
            background: #111; padding: 25px; text-align: center; border-bottom: 2px solid var(--gold); 
            position: sticky; top: 0; z-index: 100; 
        }
        header h1 { font-family: 'Playfair Display'; color: var(--gold); margin: 0; font-size: 1.8rem; letter-spacing: 2px; }

        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; }
        .tab { flex: 1; padding: 15px; text-align: center; background: var(--card); cursor: pointer; font-weight: bold; border-radius: 8px; border: 1px solid #333; color: #888; transition: 0.3s; }
        .tab.active { background: var(--gold); color: #111; border-color: var(--gold); }

        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Agenda */
        .agenda-controls { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 25px; display: flex; gap: 10px; align-items: flex-end; }
        .reserva-item { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        .reserva-header { font-weight: bold; font-size: 1.2rem; color: var(--gold); }
        .reserva-detalles { font-size: 0.9rem; margin-top: 5px; color: #ccc; }

        /* Servicios */
        .form-servicios { background: var(--card); padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #444; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; background: #111; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        
        .btn-main { padding: 12px 18px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn-save { background: var(--gold); color: #111; }
        .btn-cancel { background: #555; color: white; margin-top: 10px; display: none; }

        .grid-servicios { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card-admin { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        .card-admin img { width: 100%; height: 160px; object-fit: cover; }
        .card-info { padding: 15px; }
        .card-actions { display: flex; gap: 10px; margin-top: 10px; }
        
        .btn-edit { background: var(--blue); color: white; flex: 1; padding: 8px; border-radius: 5px; cursor: pointer; border: none; }
        .btn-del { background: var(--red); color: white; flex: 1; padding: 8px; border-radius: 5px; cursor: pointer; border: none; }
        .btn-wa { background: #25d366; color: white; text-decoration: none; padding: 8px 12px; border-radius: 5px; display: inline-block; margin-top: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

<header>
    <h1>ADMIN MILOCOSTUDIO</h1>
</header>

<div class="container">
    <div class="tabs">
        <div class="tab active" id="tabBtnAgenda">AGENDA</div>
        <div class="tab" id="tabBtnServicios">SERVICIOS</div>
    </div>

    <div id="panelAgenda" class="panel active">
        <div class="agenda-controls">
            <div style="flex: 2;">
                <label style="font-size: 0.8rem; color: var(--gold);">Filtrar por fecha:</label>
                <input type="date" id="filtroFecha" style="margin-bottom: 0;">
            </div>
            <button class="btn-main btn-save" id="btnFiltrar" style="flex: 1;">VER D√çA</button>
        </div>
        <h2 id="tituloAgenda" style="color:var(--gold)">Turnos Pr√≥ximos</h2>
        <div id="listaReservas">Cargando agenda...</div>
    </div>

    <div id="panelServicios" class="panel">
        <div class="form-servicios">
            <h3 id="formTitle" style="margin-top:0; color:var(--gold)">AGREGAR NUEVO SERVICIO</h3>
            <input id="sNombre" placeholder="Nombre del servicio">
            <input id="sPrecio" placeholder="Precio (ej: 1500)">
            <input id="sDesc" placeholder="Descripci√≥n">
            <input id="sImg" placeholder="URL de la Imagen">
            
            <button class="btn-main btn-save" id="btnGuardarServicio">GUARDAR SERVICIO</button>
            <button class="btn-main btn-cancel" id="btnCancelarEdicion">CANCELAR EDICI√ìN</button>
        </div>
        <div class="grid-servicios" id="listaServicios"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, push, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCb47oi5HqrgrqIc1jwukF-igINVSOm5Pk",
        authDomain: "milocostudio-a1528.firebaseapp.com",
        databaseURL: "https://milocostudio-a1528-default-rtdb.firebaseio.com",
        projectId: "milocostudio-a1528",
        storageBucket: "milocostudio-a1528.firebasestorage.app",
        messagingSenderId: "578653241182",
        appId: "1:578653241182:web:dd263f3c6781de8a9ed9cf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let idServicioEnEdicion = null;

    // --- L√ìGICA DE AGENDA ---
    async function cargarAgenda(fechaFiltro = null) {
        const contenedor = document.getElementById('listaReservas');
        contenedor.innerHTML = "Cargando...";
        
        let dbRef = ref(db, 'reservas');
        if (fechaFiltro) {
            dbRef = query(ref(db, 'reservas'), orderByChild('fecha'), equalTo(fechaFiltro));
        }

        const snap = await get(dbRef);
        contenedor.innerHTML = "";

        if (!snap.exists()) {
            contenedor.innerHTML = "<p style='color:#888;'>No hay citas registradas.</p>";
            return;
        }

        // Convertir a array para ordenar por hora
        const reservas = Object.entries(snap.val()).sort((a,b) => a[1].hora.localeCompare(b[1].hora));

        reservas.forEach(([id, r]) => {
            const card = document.createElement('div');
            card.className = 'reserva-item';
            
            // Unificamos nombres de campos para evitar "undefined"
            const nombreCli = r.nombre || r.nombreCliente || "Cliente";
            const whatsappCli = r.whatsapp || r.tel || r.telefono || "";

            card.innerHTML = `
                <div>
                    <div class="reserva-header">${r.hora} hs - ${nombreCli}</div>
                    <div class="reserva-detalles">
                        <b>Servicio:</b> ${r.servicio} <br>
                        <b>Fecha:</b> ${r.fecha} <br>
                        ${whatsappCli ? `<a href="https://wa.me/${whatsappCli}" target="_blank" class="btn-wa">üì± WhatsApp</a>` : ''}
                    </div>
                </div>
                <button class="btn-del" data-id="${id}" style="width:auto; padding:10px 15px;">‚úï</button>
            `;
            contenedor.appendChild(card);
        });

        document.querySelectorAll('#listaReservas .btn-del').forEach(btn => {
            btn.onclick = async () => {
                if(confirm("¬øEliminar este turno de la agenda?")) {
                    await remove(ref(db, `reservas/${btn.dataset.id}`));
                    cargarAgenda(fechaFiltro);
                }
            };
        });
    }

    // --- L√ìGICA DE SERVICIOS ---
    async function cargarServicios() {
        const snap = await get(ref(db, 'servicios'));
        const grid = document.getElementById('listaServicios');
        grid.innerHTML = "";
        if (!snap.exists()) return;

        Object.entries(snap.val()).forEach(([id, s]) => {
            const card = document.createElement('div');
            card.className = 'card-admin';
            card.innerHTML = `
                <img src="${s.imagen || 'https://via.placeholder.com/300x160'}">
                <div class="card-info">
                    <b>${s.nombre}</b><br>
                    <span style="color:var(--gold)">$${s.precio}</span>
                    <div class="card-actions">
                        <button class="btn-edit" data-id="${id}">Editar</button>
                        <button class="btn-del-ser" data-id="${id}">Borrar</button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });

        document.querySelectorAll('.btn-edit').forEach(b => b.onclick = () => prepararEdicion(b.dataset.id));
        document.querySelectorAll('.btn-del-ser').forEach(b => b.onclick = () => eliminarServicio(b.dataset.id));
    }

    async function prepararEdicion(id) {
        const snap = await get(ref(db, `servicios/${id}`));
        const s = snap.val();
        document.getElementById('sNombre').value = s.nombre;
        document.getElementById('sPrecio').value = s.precio;
        document.getElementById('sDesc').value = s.descripcion || "";
        document.getElementById('sImg').value = s.imagen || "";
        
        idServicioEnEdicion = id;
        document.getElementById('formTitle').innerText = "EDITANDO SERVICIO";
        document.getElementById('btnGuardarServicio').innerText = "ACTUALIZAR CAMBIOS";
        document.getElementById('btnCancelarEdicion').style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('btnGuardarServicio').onclick = async () => {
        const datos = {
            nombre: document.getElementById('sNombre').value,
            precio: document.getElementById('sPrecio').value,
            descripcion: document.getElementById('sDesc').value,
            imagen: document.getElementById('sImg').value
        };
        if(!datos.nombre || !datos.precio) return alert("Completa los campos");

        if(idServicioEnEdicion) {
            await update(ref(db, `servicios/${idServicioEnEdicion}`), datos);
        } else {
            await push(ref(db, 'servicios'), datos);
        }
        resetForm();
        cargarServicios();
    };

    async function eliminarServicio(id) {
        if(confirm("¬øBorrar este servicio permanentemente?")) {
            await remove(ref(db, `servicios/${id}`));
            cargarServicios();
        }
    }

    function resetForm() {
        idServicioEnEdicion = null;
        document.getElementById('sNombre').value = "";
        document.getElementById('sPrecio').value = "";
        document.getElementById('sDesc').value = "";
        document.getElementById('sImg').value = "";
        document.getElementById('formTitle').innerText = "AGREGAR NUEVO SERVICIO";
        document.getElementById('btnGuardarServicio').innerText = "GUARDAR SERVICIO";
        document.getElementById('btnCancelarEdicion').style.display = "none";
    }

    // --- NAVEGACI√ìN Y FILTROS ---
    document.getElementById('btnFiltrar').onclick = () => {
        const val = document.getElementById('filtroFecha').value;
        cargarAgenda(val);
    };

    document.getElementById('tabBtnAgenda').onclick = () => {
        document.querySelectorAll('.tab, .panel').forEach(el => el.classList.remove('active'));
        document.getElementById('tabBtnAgenda').classList.add('active');
        document.getElementById('panelAgenda').classList.add('active');
        cargarAgenda();
    };

    document.getElementById('tabBtnServicios').onclick = () => {
        document.querySelectorAll('.tab, .panel').forEach(el => el.classList.remove('active'));
        document.getElementById('tabBtnServicios').classList.add('active');
        document.getElementById('panelServicios').classList.add('active');
        cargarServicios();
    };

    document.getElementById('btnCancelarEdicion').onclick = resetForm;

    // Carga inicial
    document.getElementById('filtroFecha').valueAsDate = new Date();
    cargarAgenda();
</script>

</body>
</html>
